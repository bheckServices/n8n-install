# Security Standards

**Scope:** Secret management, authentication, authorization, and compliance for the n8n-install infrastructure.

---

## üéØ Security Principles

1. **Defense in Depth** - Multiple layers of security
2. **Least Privilege** - Services get minimal required permissions
3. **Secrets Never in Code** - Use .env, never hardcode
4. **Secure by Default** - All admin interfaces behind authentication
5. **Audit Trail** - Log access and changes

---

## üîê Secret Management

### Secret Storage

**‚úÖ CORRECT:**
```bash
# Store in .env (gitignored)
POSTGRES_PASSWORD=generated_secure_value_here

# Reference in docker-compose.yml
environment:
  - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
```

**‚ùå WRONG:**
```yaml
# Never hardcode secrets
environment:
  - POSTGRES_PASSWORD=mysecretpassword  # NEVER DO THIS
```

### Secret Generation

All secrets are generated by `scripts/03_generate_secrets.sh`:

```bash
# Password pattern: 32+ characters, alphanumeric
POSTGRES_PASSWORD=$(openssl rand -base64 32 | tr -d '/+=')

# API key pattern: 64 hex characters
FLOWISE_API_KEY=$(openssl rand -hex 32)

# Encryption key pattern: base64-encoded 32 bytes
N8N_ENCRYPTION_KEY=$(openssl rand -base64 32)

# JWT secret pattern: base64-encoded 64 bytes
JWT_SECRET=$(openssl rand -base64 64)
```

### Secret Types and Suffixes

| Suffix | Purpose | Generation Method | Example |
|--------|---------|------------------|---------|
| `_PASSWORD` | User/service passwords | `openssl rand -base64 32` | `POSTGRES_PASSWORD` |
| `_PASSWORD_HASH` | Bcrypt hashes for Caddy | `caddy hash-password` | `N8N_BASIC_AUTH_PASSWORD_HASH` |
| `_API_KEY` | API authentication | `openssl rand -hex 32` | `FLOWISE_API_KEY` |
| `_SECRET` | JWT/session secrets | `openssl rand -base64 64` | `JWT_SECRET` |
| `_ENCRYPTION_KEY` | Data encryption | `openssl rand -base64 32` | `N8N_ENCRYPTION_KEY` |

### .env File Protection

```bash
# File permissions (already handled by install.sh)
chmod 600 .env
chown root:root .env  # On production systems

# Git protection (.gitignore already includes)
.env
.env.local
.env.*.local

# Backup protection
# When backing up configs, ensure .env is encrypted or stored securely
```

### Secret Rotation

**When to rotate:**
- Immediately if secret is compromised
- Every 90 days for compliance (optional, infra-dependent)
- Before production deployment (rotate default/test secrets)
- After employee/team member offboarding

**How to rotate:**

```bash
# 1. Backup current .env
cp .env .env.backup

# 2. Update specific secret in .env
# Edit manually or regenerate all secrets
bash ./scripts/03_generate_secrets.sh

# 3. Restart affected services
docker compose -p localai up -d --force-recreate <service>

# 4. Verify service still works
bash ./scripts/status_report.sh

# 5. Update any external references (n8n workflows, API clients)
```

---

## üîí Authentication & Authorization

### Caddy Basic Authentication

**Pattern:** All admin/sensitive interfaces use HTTP Basic Auth via Caddy.

```caddyfile
# Example: Protect Grafana
{$GRAFANA_HOSTNAME} {
    basicauth {
        {$GRAFANA_USER} {$GRAFANA_PASSWORD_HASH}
    }
    reverse_proxy n8nInstall_grafana:3000
}
```

**Password hashing:**
```bash
# Generate bcrypt hash (requires Caddy container running)
docker exec n8nInstall_caddy caddy hash-password --plaintext "your_password"

# Output format (use in Caddyfile env vars)
$2a$14$Xyz...  # This goes in _PASSWORD_HASH variable
```

**When to use Basic Auth:**
- ‚úÖ Admin dashboards (Grafana, pgAdmin)
- ‚úÖ Dev tools (debugging interfaces)
- ‚úÖ n8n (first layer, then n8n's own auth)
- ‚ùå Public APIs (use API keys instead)
- ‚ùå User-facing interfaces (use app-level auth)

### Service-Level Authentication

| Service | Auth Method | Notes |
|---------|-------------|-------|
| **n8n** | Basic Auth + n8n internal auth | Double-layer protection |
| **Postgres** | Username/password | Internal only, not exposed |
| **Redis** | Password (optional) | Internal only |
| **Grafana** | Basic Auth + Grafana login | Admin access only |
| **pgAdmin** | Basic Auth + pgAdmin login | Admin access only |
| **Flowise** | API key | For programmatic access |
| **Langfuse** | API keys | For observability data |

### Network Isolation

**All services run on isolated network:**

```yaml
networks:
  n8nInstall_network:
    driver: bridge
    name: n8nInstall_network
```

**Benefits:**
- Services can only talk to each other, not other Docker containers
- External access only via Caddy reverse proxy
- Reduces attack surface

**Validation:**
```bash
# Verify network isolation
docker network inspect n8nInstall_network

# Should show only n8nInstall_ containers
```

---

## üåê HTTPS & TLS

### Certificate Management (Caddy)

**Automatic HTTPS:**
```caddyfile
# Caddy automatically obtains Let's Encrypt certificates when:
# 1. LETSENCRYPT_EMAIL is set in .env
# 2. DNS is configured correctly
# 3. Ports 80/443 are accessible

{$N8N_HOSTNAME} {
    # HTTPS is automatic, no configuration needed
    reverse_proxy n8nInstall_n8n:5678
}
```

**Certificate storage:**
```bash
# Caddy stores certs in Docker volume
docker volume inspect n8nInstall_caddy_data

# Check certificate status
docker exec n8nInstall_caddy caddy list-certificates
```

**Local development (no real domain):**
```bash
# Use .localhost domains for local testing
N8N_HOSTNAME=n8n.localhost

# Caddy uses self-signed certificates
# Access with -k flag: curl -k https://n8n.localhost
```

### TLS Configuration

**Minimum TLS version:** TLS 1.2 (Caddy default)

**Cipher suites:** Caddy's secure defaults (no need to override)

**HSTS:** Enabled automatically by Caddy for HTTPS domains

---

## üõ°Ô∏è Security Best Practices

### Container Security

```yaml
# Run as non-root when possible (service-dependent)
user: "1000:1000"

# Read-only root filesystem (when applicable)
read_only: true
tmpfs:
  - /tmp

# Drop unnecessary capabilities
cap_drop:
  - ALL
cap_add:
  - NET_BIND_SERVICE  # Only if needed
```

### Volume Security

```yaml
# Prefer named volumes (managed by Docker)
volumes:
  - n8nInstall_postgres_data:/var/lib/postgresql/data

# Bind mounts: Use specific paths, avoid mounting root
volumes:
  - ./specific/path:/container/path:ro  # Read-only when possible
```

### Environment Variable Exposure

```bash
# ‚úÖ CORRECT: Load from .env
docker compose -p localai up -d

# ‚ùå WRONG: Expose secrets in command line
docker run -e POSTGRES_PASSWORD=secret ...  # Visible in process list
```

### Logging Security

```bash
# Never log secrets
echo "Connecting to database..."  # ‚úÖ CORRECT

# ‚ùå WRONG
echo "Using password: ${POSTGRES_PASSWORD}"  # Exposes secret in logs
```

---

## üîç Security Monitoring

### Log Monitoring

**What to monitor:**
- Failed authentication attempts (Caddy logs)
- Unauthorized access attempts (403/401 responses)
- Container restarts (potential crashes/exploits)
- Unusual network traffic

**How to monitor:**
```bash
# Check Caddy access logs for auth failures
docker logs n8nInstall_caddy | grep " 401 "
docker logs n8nInstall_caddy | grep " 403 "

# Check for container restarts
docker ps -a --filter "name=n8nInstall_" --format "{{.Names}}: {{.Status}}"

# Check service logs for errors
docker compose -p localai logs --since 1h | grep -i error
```

### Security Scanning (Optional)

```bash
# Scan Docker images for vulnerabilities (using Trivy)
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
  aquasec/trivy image n8nio/n8n:latest

# Scan for exposed secrets in code (using gitleaks)
docker run --rm -v $(pwd):/path zricethezav/gitleaks:latest \
  detect --source /path --verbose
```

---

## üö® Incident Response

### Suspected Compromise

**Immediate actions:**

1. **Isolate affected service**
   ```bash
   docker compose -p localai stop <compromised-service>
   ```

2. **Rotate all secrets**
   ```bash
   bash ./scripts/backup_config.sh
   bash ./scripts/03_generate_secrets.sh
   docker compose -p localai up -d --force-recreate
   ```

3. **Review logs for IOCs (Indicators of Compromise)**
   ```bash
   docker logs n8nInstall_<service> --since <incident-time> > incident-logs.txt
   docker logs n8nInstall_caddy --since <incident-time> > caddy-incident-logs.txt
   ```

4. **Check for backdoors/modifications**
   ```bash
   # Compare running containers to known-good images
   docker diff n8nInstall_<service>

   # Check for unexpected processes
   docker exec n8nInstall_<service> ps aux
   ```

5. **Notify stakeholders** and document in incident report

### Post-Incident

- [ ] Update affected secrets
- [ ] Patch vulnerable services
- [ ] Review access logs
- [ ] Document lessons learned in AIP
- [ ] Update monitoring/alerting rules

---

## üìú Compliance Considerations

### Data Protection (GDPR, etc.)

**PII Storage:**
- n8n workflows may process PII - document data flows
- Postgres contains workflow data - ensure backups are encrypted
- Logs may contain sensitive data - implement log retention policy

**Right to Erasure:**
- Document how to purge user data from n8n
- Ensure database backups can be sanitized

### Access Control

**Admin Access:**
- Use strong unique passwords for all services
- Rotate credentials after team member changes
- Document who has access to what

**Audit Logging:**
- Caddy logs all HTTP requests with timestamps
- Docker logs all container events
- Consider centralized log aggregation for compliance

### Backup Security

```bash
# Encrypt backups before storage
tar czf - .env docker-compose.yml Caddyfile | \
  openssl enc -aes-256-cbc -salt -out backup-$(date +%F).tar.gz.enc

# Decrypt when needed
openssl enc -d -aes-256-cbc -in backup.tar.gz.enc | tar xzf -
```

---

## ‚úÖ Security Checklist (Pre-Production)

Before deploying to production:

- [ ] All secrets generated and unique (not defaults)
- [ ] .env file has correct permissions (600)
- [ ] All admin interfaces behind Basic Auth
- [ ] HTTPS enabled with valid certificates
- [ ] No ports exposed except 80/443 (Caddy only)
- [ ] Network isolation configured (n8nInstall_network)
- [ ] Container names have n8nInstall_ prefix
- [ ] Secrets not committed to Git
- [ ] Backup strategy documented and tested
- [ ] Incident response plan documented
- [ ] Log monitoring configured (Grafana alerts optional)
- [ ] Security scanning completed (optional but recommended)

---

## üîó Related Documentation

- [CONFIGURATION-MANAGEMENT.md](./CONFIGURATION-MANAGEMENT.md) - .env structure
- [DEPLOYMENT.md](./DEPLOYMENT.md) - Production deployment checklist
- [TROUBLESHOOTING.md](./TROUBLESHOOTING.md) - Common security-related issues

---

**Maintained By:** Project maintainers and AI agents
**Last Updated:** 2025-12-01
