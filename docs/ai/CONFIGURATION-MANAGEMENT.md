# Configuration Management

**Scope:** Environment variables, profile activation, secret generation, and .env file structure.

---

## üéØ Configuration Philosophy

1. **Single Source of Truth** - `.env` file contains all configuration
2. **Never Hardcode** - All values come from environment variables
3. **Secure by Default** - Secrets are generated, never committed to Git
4. **Validated on Startup** - Scripts check required variables exist
5. **Documented Defaults** - `.env.example` shows all available options

---

## üìÑ .env File Structure

### Template (.env.example)

The `.env.example` file serves as:
- Documentation of all available variables
- Template for generating `.env`
- Reference for adding new services

**Structure:**
```bash
# ============================================================================
# Core Infrastructure
# ============================================================================
COMPOSE_PROFILES=["n8n"]  # JSON array of active profiles
LETSENCRYPT_EMAIL=you@example.com

# ============================================================================
# Service: PostgreSQL (Core - No Profile)
# ============================================================================
POSTGRES_USER=n8n
POSTGRES_PASSWORD=  # Generated by install script
POSTGRES_DB=n8n

# ============================================================================
# Service: Redis/Valkey (Core - No Profile)
# ============================================================================
REDIS_PASSWORD=  # Generated by install script

# ============================================================================
# Service: n8n (Profile: n8n)
# ============================================================================
N8N_HOSTNAME=n8n.yourdomain.com
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=  # Generated by install script
N8N_BASIC_AUTH_PASSWORD_HASH=  # Generated by install script
N8N_ENCRYPTION_KEY=  # Generated by install script
N8N_WORKER_COUNT=1

# ============================================================================
# Service: Flowise (Profile: flowise)
# ============================================================================
FLOWISE_HOSTNAME=flowise.yourdomain.com
FLOWISE_API_KEY=  # Generated by install script

# ... (continues for all services)
```

### Generated .env

During installation (`scripts/install.sh`), the `.env` file is created:

1. **Copy from example:** `cp .env.example .env`
2. **Generate secrets:** `scripts/03_generate_secrets.sh` fills empty values
3. **User input:** Wizard prompts for hostnames, profiles, email
4. **Validation:** Check all required variables are set

---

## üîê Secret Generation

### Generation Script: `scripts/03_generate_secrets.sh`

**Purpose:** Auto-generate secure random values for passwords, keys, and hashes.

**Workflow:**
1. Load existing `.env` (if exists)
2. For each variable in `VARS_TO_GENERATE`:
   - If variable is empty or unset ‚Üí generate new value
   - If variable has user-provided value ‚Üí keep it (don't overwrite)
3. Write updated values to `.env`

### Secret Types

Defined in `VARS_TO_GENERATE` map:

```bash
# Format: "VAR_NAME:type:param"

VARS_TO_GENERATE=(
    # Passwords: random alphanumeric, length specified
    "POSTGRES_PASSWORD:password:32"

    # JWT secrets: base64-encoded random bytes
    "JWT_SECRET:jwt"

    # API keys: hex-encoded random bytes
    "FLOWISE_API_KEY:api_key"

    # Encryption keys: base64-encoded 32 bytes (AES-256)
    "N8N_ENCRYPTION_KEY:encryption_key"

    # Basic auth: generates password + bcrypt hash
    "N8N_BASIC_AUTH_PASSWORD:basic_auth"
    # ‚Üë Also creates N8N_BASIC_AUTH_PASSWORD_HASH automatically
)
```

### Generation Methods

#### Password (alphanumeric)
```bash
# Length: 32 characters
openssl rand -base64 32 | tr -d '/+=' | head -c 32
```

#### API Key (hexadecimal)
```bash
# 64 hex characters (32 bytes)
openssl rand -hex 32
```

#### Encryption Key (base64)
```bash
# 32 bytes for AES-256
openssl rand -base64 32
```

#### JWT Secret (base64)
```bash
# 64 bytes
openssl rand -base64 64
```

#### Basic Auth (password + bcrypt hash)
```bash
# 1. Generate password
password=$(openssl rand -base64 32 | tr -d '/+=' | head -c 32)

# 2. Generate bcrypt hash using Caddy
# Requires Caddy container to be running
docker exec n8nInstall_caddy caddy hash-password --plaintext "$password"

# 3. Store both in .env
N8N_BASIC_AUTH_PASSWORD=$password
N8N_BASIC_AUTH_PASSWORD_HASH=<bcrypt-output>
```

### Adding New Secret Variables

When adding a service that needs secrets:

1. **Add to `.env.example`:**
   ```bash
   # Service: MyService (Profile: myservice)
   MYSERVICE_HOSTNAME=myservice.yourdomain.com
   MYSERVICE_PASSWORD=  # Generated by install script
   MYSERVICE_PASSWORD_HASH=  # Generated by install script
   ```

2. **Add to `scripts/03_generate_secrets.sh`:**
   ```bash
   VARS_TO_GENERATE=(
       # ... existing vars ...
       "MYSERVICE_PASSWORD:basic_auth"
   )
   ```

3. **Update documentation:** Add to [SERVICE-REGISTRY.md](./SERVICE-REGISTRY.md)

---

## üéõÔ∏è Profile Management

### Profile Variable: `COMPOSE_PROFILES`

**Format:** JSON array of profile names

```bash
# Single profile
COMPOSE_PROFILES=["n8n"]

# Multiple profiles
COMPOSE_PROFILES=["n8n","flowise","monitoring"]

# No profiles (core services only)
COMPOSE_PROFILES=[]
```

### Setting Profiles

**At install time:**
```bash
# Wizard (scripts/04_wizard.sh) prompts user
# Selected services are written to COMPOSE_PROFILES
```

**Manually editing:**
```bash
# Edit .env
COMPOSE_PROFILES=["n8n","pgadmin"]

# Apply changes
docker compose -p localai up -d
# Services not in active profiles will stop
```

### Profile Detection in Scripts

```bash
# Function to check if profile is active
function is_profile_active() {
    local profile_name="$1"
    source .env 2>/dev/null || return 1

    grep -q "\"${profile_name}\"" <<< "${COMPOSE_PROFILES:-}" || \
    grep -q "${profile_name}" <<< "${COMPOSE_PROFILES:-}"
}

# Usage
if is_profile_active "monitoring"; then
    echo "Monitoring stack is enabled"
fi
```

---

## üåê Hostname Configuration

### Hostname Pattern

**Convention:** Each service gets a `_HOSTNAME` variable

```bash
# .env.example
N8N_HOSTNAME=n8n.yourdomain.com
FLOWISE_HOSTNAME=flowise.yourdomain.com
GRAFANA_HOSTNAME=grafana.yourdomain.com
PGADMIN_HOSTNAME=pgadmin.yourdomain.com
```

### DNS Setup Strategies

**Option 1: Wildcard DNS (Recommended)**
```
*.yourdomain.com  ‚Üí  <server-ip>
```
- All subdomains automatically resolve
- No need to add DNS entries per service
- Easy to add new services

**Option 2: Individual DNS Entries**
```
n8n.yourdomain.com      ‚Üí  <server-ip>
flowise.yourdomain.com  ‚Üí  <server-ip>
grafana.yourdomain.com  ‚Üí  <server-ip>
```
- More granular control
- Can point services to different IPs

**Option 3: Local Development (.localhost)**
```bash
N8N_HOSTNAME=n8n.localhost
FLOWISE_HOSTNAME=flowise.localhost
```
- No DNS configuration needed
- Caddy uses self-signed certificates
- Access with `curl -k https://n8n.localhost`

### Hostname Validation

```bash
# Check hostname format (alphanumeric, dots, hyphens only)
function validate_hostname() {
    local hostname="$1"
    if [[ ! "$hostname" =~ ^[a-zA-Z0-9.-]+$ ]]; then
        echo "ERROR: Invalid hostname format: $hostname" >&2
        return 1
    fi
}
```

---

## üîÑ Variable Precedence

When a variable is defined in multiple places:

**Priority (highest to lowest):**
1. **Runtime override:** `VAR=value docker compose up`
2. **.env file:** `VAR=value` in `.env`
3. **docker-compose.yml default:** `${VAR:-default}`
4. **System environment:** Existing shell variable

**Example:**
```yaml
# docker-compose.yml
environment:
  - WORKER_COUNT=${N8N_WORKER_COUNT:-1}

# .env
N8N_WORKER_COUNT=3

# Runtime override
N8N_WORKER_COUNT=5 docker compose up -d
# ‚Üë Container uses 5 (runtime wins)

# Without runtime override
docker compose up -d
# ‚Üë Container uses 3 (from .env)

# Without .env value
# N8N_WORKER_COUNT not in .env
docker compose up -d
# ‚Üë Container uses 1 (default from docker-compose.yml)
```

---

## ‚úÖ Variable Validation

### Required Variables Check

**Script pattern:**
```bash
#!/usr/bin/env bash
set -euo pipefail

# Load .env
if [[ ! -f .env ]]; then
    echo "ERROR: .env file not found. Run install.sh first." >&2
    exit 1
fi

source .env

# Check required variables
REQUIRED_VARS=(
    "COMPOSE_PROFILES"
    "LETSENCRYPT_EMAIL"
    "POSTGRES_PASSWORD"
    "N8N_HOSTNAME"
)

for var in "${REQUIRED_VARS[@]}"; do
    if [[ -z "${!var:-}" ]]; then
        echo "ERROR: Required variable $var is not set in .env" >&2
        exit 1
    fi
done
```

### Empty Variable Detection

```bash
# Find variables with empty values
grep "^[A-Z_]*=$" .env

# Should return nothing (all variables should have values or be commented)
```

---

## üì¶ Variable Categories

### Core Infrastructure Variables

**Always required:**
```bash
COMPOSE_PROFILES=["n8n"]
LETSENCRYPT_EMAIL=you@example.com
POSTGRES_USER=n8n
POSTGRES_PASSWORD=<generated>
POSTGRES_DB=n8n
REDIS_PASSWORD=<generated>
```

### Service-Specific Variables

**Per-service pattern:**
```bash
# Hostname (public access)
SERVICE_HOSTNAME=service.yourdomain.com

# Authentication (if using Basic Auth)
SERVICE_USER=admin
SERVICE_PASSWORD=<generated>
SERVICE_PASSWORD_HASH=<generated>

# Secrets (if needed)
SERVICE_API_KEY=<generated>
SERVICE_ENCRYPTION_KEY=<generated>

# Feature flags (optional)
SERVICE_FEATURE_ENABLED=true
```

### Optional/Feature Flags

```bash
# Worker scaling
N8N_WORKER_COUNT=1

# Debug mode
N8N_LOG_LEVEL=info

# Custom paths
SHARED_DATA_PATH=./shared
```

---

## üîê Security Best Practices

### .env File Protection

```bash
# Set restrictive permissions
chmod 600 .env
chown root:root .env  # On production

# Verify not tracked by Git
git check-ignore .env  # Should output: .env

# Never commit to repository
# .gitignore already contains:
.env
.env.local
.env.*.local
```

### Secret Rotation Procedure

```bash
# 1. Backup current .env
cp .env .env.backup.$(date +%F)

# 2. Regenerate specific secret or all secrets
bash scripts/03_generate_secrets.sh

# 3. Restart affected services
docker compose -p localai up -d --force-recreate <service>

# 4. Verify service works
bash scripts/status_report.sh

# 5. Update external references (API clients, n8n credentials, etc.)
```

---

## üìã Configuration Checklist

Before deployment:

- [ ] `.env` file exists (not `.env.example`)
- [ ] All required variables have values (no empty `VAR=`)
- [ ] Secrets are generated (not default/example values)
- [ ] Hostnames match DNS configuration
- [ ] `LETSENCRYPT_EMAIL` is valid email
- [ ] `COMPOSE_PROFILES` includes desired services
- [ ] File permissions: `chmod 600 .env`
- [ ] Not tracked in Git: `git status .env` shows nothing

---

## üîó Related Documentation

- [SECURITY.md](./SECURITY.md) - Secret management and protection
- [PLATFORM-ARCHITECTURE.md](./PLATFORM-ARCHITECTURE.md) - Profile system architecture
- [SERVICE-REGISTRY.md](./SERVICE-REGISTRY.md) - Service-specific variables

---

**Maintained By:** Project maintainers and AI agents
**Last Updated:** 2025-12-01
